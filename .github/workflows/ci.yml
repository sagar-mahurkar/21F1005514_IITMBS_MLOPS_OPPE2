# ==============================================================
# GitHub Actions Workflow: Train + Test + MLflow
# Heart Disease ML Pipeline
# ==============================================================

name: Train and Test Model

# --------------------------------------------------------------
# Triggers
# --------------------------------------------------------------
on:
  workflow_dispatch:
  push:
    branches:
      - "**"
    paths:
      - "**.py"
      - "data.csv"
      - "requirements.txt"
      - "artifacts/**"
      - ".github/workflows/*"
  pull_request:
    branches:
      - "**"

# --------------------------------------------------------------
# Permissions
# --------------------------------------------------------------
permissions:
  contents: write
  pull-requests: write

# --------------------------------------------------------------
# Job Definition
# --------------------------------------------------------------
jobs:
  train_and_test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ----------------------------------------------------------
      # Step 1: Checkout repository
      # ----------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # Step 2: Setup Python
      # ----------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      # ----------------------------------------------------------
      # Step 3: Setup CML
      # ----------------------------------------------------------
      - name: Setup CML
        uses: iterative/setup-cml@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------
      # Step 4: Install dependencies
      # ----------------------------------------------------------
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ----------------------------------------------------------
      # Step 5: Verify data.csv exists
      # ----------------------------------------------------------
      - name: Verify data.csv exists
        run: |
          if [ ! -f data.csv ]; then
            echo "âŒ data.csv not found!"
            ls -R .
            exit 1
          fi
          echo "âœ… data.csv found"

      # ----------------------------------------------------------
      # Step 6: Train model (MLflow = best effort)
      # ----------------------------------------------------------
      - name: Train model
        env:
          MLFLOW_TRACKING_URI: http://35.188.33.106:5000
        run: |
          echo "ğŸš€ Training model (MLflow best-effort)..."
          python train.py > train_output.txt 2>&1 || \
          echo "âš ï¸ Training failed, continuing pipeline"
      
      # ----------------------------------------------------------
      # Step 7: Wait for MLflow server + Fetch model
      # ----------------------------------------------------------
      - name: Fetch model from MLflow (wait & retry)
        env:
          MLFLOW_TRACKING_URI: http://35.188.33.106:5000
        run: |
          echo "ğŸ“¥ Waiting for MLflow server..."
      
          MAX_RETRIES=10
          SLEEP_SECONDS=15
          ATTEMPT=1
      
          # ---- Wait for MLflow HTTP endpoint ----
          until curl -sf $MLFLOW_TRACKING_URI > /dev/null; do
            echo "â³ MLflow server not reachable yet..."
            sleep 5
          done
      
          echo "âœ… MLflow server reachable"
      
          # ---- Fetch model with retries ----
          while [ $ATTEMPT -le $MAX_RETRIES ]; do
            echo "ğŸ”„ Fetch attempt $ATTEMPT / $MAX_RETRIES"
      
            if python fetch_from_mlflow.py >> train_output.txt 2>&1; then
              echo "âœ… MLflow fetch successful"
              break
            else
              echo "â³ Model not registered yet, retrying in $SLEEP_SECONDS seconds..."
              sleep $SLEEP_SECONDS
            fi
      
            ATTEMPT=$((ATTEMPT+1))
          done
      
          if [ $ATTEMPT -gt $MAX_RETRIES ]; then
            echo "âš ï¸ Model not available in MLflow after retries"
          fi


      # ----------------------------------------------------------
      # Step 8: Verify model artifact (local training)
      # ----------------------------------------------------------
      - name: Verify model artifact
        run: |
          if [ ! -f artifacts/model.joblib ]; then
            echo "âŒ Model artifact not found!"
            ls -R .
            exit 1
          fi
          echo "âœ… Model artifact exists"

      # ----------------------------------------------------------
      # Step 9: Run unit tests (VERBOSE)
      # ----------------------------------------------------------
      - name: Run tests (verbose)
        run: |
          echo "ğŸ§ª Running unit tests..."
          python -m unittest -v test_model.py > test_output.txt 2>&1

      # ----------------------------------------------------------
      # Step 10: Show logs (debug)
      # ----------------------------------------------------------
      - name: Show logs
        run: |
          echo "===== ğŸ§  TRAINING + MLFLOW LOG ====="
          cat train_output.txt || true
          echo ""
          echo "===== ğŸ§ª TEST LOG ====="
          cat test_output.txt || true

      # ----------------------------------------------------------
      # Step 11: Publish CML report
      # ----------------------------------------------------------
      - name: Publish CML report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ğŸ§  Training + MLflow Output" > report.md
          echo '```' >> report.md
          cat train_output.txt >> report.md
          echo '```' >> report.md

          echo "" >> report.md
          echo "## ğŸ§ª Unit Test Output" >> report.md
          echo '```' >> report.md
          cat test_output.txt >> report.md
          echo '```' >> report.md

          cml comment create --publish report.md
